---
title: "HW2"
format: html
author: Sofia Rodas
Date: January 28, 2026
warning: false
message: false 
---

This quarto document explores FEMA National Risk Index scores throughout California in comparison to the NRI scores in other states. 

How do FEMA National Risk Index scores for counties in California compare to those in other states? 

```{r}
# load necessary libraries
library(tidyverse)
library(janitor)
library(tidycensus)
library(sf)
library(tmap)
library(terra)
```

```{r}
# read in data
nri <- read_csv(here::here("data", "National_Risk_Index_Counties.csv"))

# clean names
nri <- clean_names(nri)
```
Check the number of states. This analysis will only include the 50 US states. 
```{r}
# number of states included
length(unique(nri$state_name))
```

Filter to only the 50 states. 
```{r}
# only select for 50 states
nri <- nri |> 
  filter(nri$state_name %in% state.name)
```

The NRI data does not include geometry. The visual would be most useful if it includes all geospatial data. Let's use the census data to get some geometry. 
```{r}
# use code from class to get state geometry
us_state_pop <- get_estimates(geography = "state", 
                              product = "population",
                              geometry = TRUE,
                              state = NULL, 
                              year = 2019) |> # request 2019 vintage for the 2010s (see documentation)
  filter(variable == "POP") |> 
  select(state = NAME, population = value) |> 
  filter(state != "Puerto Rico")

# save us pop data
write_csv(us_state_pop, file = here::here("data", "us_state_pop.csv"))
```
The CRS of the census data is not ideal for the visualization of the 50 states. Let's transform it to something more appropriate.
```{r}
us_state_pop <- st_transform(us_state_pop, crs = st_crs('EPSG:3083'))
```

Initial visualization of the US state's geometry.
```{r}
  tm_shape(us_state_pop) +
  tm_polygons()
```

How do FEMA National Risk Index scores for counties in California compare to those in other states? My interpretation of this question is to average out all of the NRI scores for each state. 
```{r}
nri_averages <- nri |> 
  group_by(state_name) |> 
  summarize(nri_perc_mean = mean(national_risk_index_state_percentile_composite),
            exp_an_loss_perc_mean = mean(expected_annual_loss_state_percentile_composite),
            soc_vul_perc_mean = mean(social_vulnerability_and_community_resilience_adjusted_expected_annual_loss_rate_national_percentile_composite)) |> 
  rename(state = state_name)
```
Join the data frames to combine the geometry with the aggregate state NRI data.
```{r}
geom_nri_avg <- full_join(nri_averages, us_state_pop, by = join_by(state))
```

To map the bubbles on the map we need to extract lat and long from the `geometry` column.
```{r}
# geom_nri_avg <- geom_nri_avg |> 
#   extract(geometry, into = c('Lat', 'Lon'), '\\((.*),(.*)\\)', conv = T)

# geom_nri_avg_ll <- geom_nri_avg |>
#   mutate(geometry = gsub('[()Â°]', '', geometry)) |>
#   separate(col = geometry, into = c('lat', 'lon'), sep = '\\,')

coords <- st_coordinates(st_centroid(geom_nri_avg$geometry))
geom_nri_avg$lon <- coords[,1]
geom_nri_avg$lat <- coords[,2]

# # mapping as an sf object requires a singular geometry column
# geom_join <- geom_nri_avg |> 
#   select(c("state", "geometry"))

# join the two df to have a single df with lat, long, and geom
# geom_nri_avg_map <- full_join(geom_join, geom_nri_avg_ll, by = join_by(state))

```

Let's make a bubble map first to explore differences in the data.
```{r}
  ggplot() +
  geom_sf(data = geom_nri_avg, aes(geometry = geometry)) +
   geom_point(data = geom_nri_avg, 
              aes(x = lon, 
                  y = lat, 
                  size = nri_perc_mean, 
                  color = nri_perc_mean),
              alpha = 0.6) +
  scale_color_viridis_c() +
  theme_minimal()
  
```
The bubble map looks awful.

Let's explore another map. The Hexbin map will have a better layout and will ensure the information on the East Coast is visible in comparison to the bubble map. The hexagons were downloaded from https://team.carto.com/u/andrew/tables/andrew.us_states_hexgrid/public/map. 
```{r}
hexagons <- read_sf("data/us_states_hexgrid.geojson")
```

How do FEMA National Risk Index scores for counties in California compare to those in other states? My interpretation of this question is to average out all of the NRI scores for each state. 
```{r}
nri_avg_hex <- nri |> 
  group_by(state_name_abbreviation) |> 
  summarize(nri_perc_mean = mean(national_risk_index_state_percentile_composite, na.rm = TRUE),
            exp_an_loss_perc_mean = mean(expected_annual_loss_state_percentile_composite, na.rm = TRUE),
            soc_vul_perc_mean = mean(social_vulnerability_and_community_resilience_adjusted_expected_annual_loss_rate_national_percentile_composite, na.rm = TRUE)) |> 
  rename(state_abbr = state_name_abbreviation)
```

The column names need to be cleaned.
```{r}
hexagons <- hexagons |> 
  rename(state_abbr = iso3166_2) |> 
   mutate(google_name = gsub(" \\(United States\\)", "", google_name))
  
```

Join the two dataframes for plotting.
```{r}
hex_nri <- left_join(nri_avg_hex, hexagons, by = join_by(state_abbr))
```

Hex-bin maps work on bins, so we'll set bins.
Look at the min and max of the NRI percentile composite score. 
```{r}
min(hex_nri$nri_perc_mean)
max(hex_nri$nri_perc_mean)
```

Create bins to include the minimum and maximum NRI values. 
```{r}
hex_nri$bin <- cut(hex_nri$nri_perc_mean,
  breaks = c(seq(from = 20, to = 100, length.out = 6)),
  labels = c("Very low", "Relatively low", "Relatively moderate", "Relatively high", "Very high"),
  include.lowest = TRUE
)
```


Plot the hexbins with national risk index state percentile composite.
```{r}
ggplot(hex_nri) + 
  geom_sf(aes(geometry = geometry, fill = bin)) + 
  geom_sf_text(aes(geometry = geometry, label = state_abbr), 
               color = "white", 
               size = 3, 
               alpha = 0.6) +
  theme_void() +
  scale_fill_manual(name = "National Risk Index \npercentile",
    values = c("#FDE4D8",
               "#F9AE8B",
               "#F5773D",
               "#C2440A",
               "#612205")) +
#  guides(fill = guide_colorbar(title.position = "top")) +
  labs(title = "State National Risk Index percentiles") 
  theme(legend.position = c(0.5, 0.9))
  
```

HW3 Exploration

The code commented out below allows us to directly download ACS census data into R. It is commented out as it was saved as a csv and is now accessed locally.

```{r}
# #....Step 1a: see all available ACS variables + descriptions.....
# acs_vars <- tidycensus::load_variables(year = 2023,
#                                        dataset = "acs1")
# 
# #..............Step 1b: import race & ethnicity data.............
# race_ethnicity <- tidycensus::get_acs(
#   geography = "county",
#   survey = "acs1",
#   # NOTE: you may not end up using all these variables
#   variables = c("B01003_001", "B02001_002", "B02001_003", 
#                 "B02001_004", "B02001_005", "B02001_006",
#                 "B02001_007", "B02001_008", "B03002_012",
#                 "B03002_002"),
#   state = "CA", 
#   year = 2023) |>
#   # join variable descriptions (so we know what's what!)
#   dplyr::left_join(acs_vars, by = dplyr::join_by(variable == name)) 
# 
# #.................Step 2: write ACS data to file.................
# readr::write_csv(race_ethnicity, here::here("data", "ACS-1yr-2023-county-race-ethnicity.csv"))

#..................Step 3: read in your CSV file.................
race_ethnicity <- readr::read_csv(here::here("data", "ACS-1yr-2023-county-race-ethnicity.csv"))
```

## Clean data

The ACS data is not "tidy-data". Lets make some changes to tidy the data.

```{r}
race_ethnicity <- race_ethnicity |>  
  pivot_wider(names_from = label, values_from = c(estimate)) |> 
  clean_names() |> 
  select(!c(moe, variable, concept, estimate_total_not_hispanic_or_latino)) # drop unnecessary columns
  
```

The data frame is still not tidy because each county name has a row for each column. Let's make one row for each county instead.

```{r}
race_ethnicity <- race_ethnicity |> 
  group_by(name) |> 
  summarise(across(starts_with("estimate_total"), ~sum(., na.rm = T))) |> 
  ungroup()
```

The ethnicity data needs to be combined with the NRI data so let's make the column only the name of the county.

```{r}
race_ethnicity <- race_ethnicity |> 
  mutate(county_name = str_remove_all(name, " County, California")) |> 
  select(!c(name)) |> 
  relocate(county_name, .before = estimate_total)
```

Filter the NRI data to only CA data.

```{r}
nri <- nri |> 
  filter(state_name == "California")
```

Join the NRI data and ethnicity data for the rest of the analysis.

```{r}
ethnicity_nri <- full_join(race_ethnicity, nri, by = join_by(county_name))
```

Change the column names

```{r}
ethnicity_nri <- ethnicity_nri |> 
  rename(total_pop = estimate_total,
         white_pop = estimate_total_white_alone,
         black_pop = estimate_total_black_or_african_american_alone,
         indigenous_pop = estimate_total_american_indian_and_alaska_native_alone,
         asian_pop = estimate_total_asian_alone,
         paci_islander_pop = estimate_total_native_hawaiian_and_other_pacific_islander_alone,
         other_race = estimate_total_some_other_race_alone,
         two_races = estimate_total_two_or_more_races,
         latino_pop = estimate_total_hispanic_or_latino)
```

First, I'll explore what the percent of total white alone is for the counties in California.

```{r}
ethnicity_nri <- ethnicity_nri |> 
  mutate(white_percentage = white_pop/total_pop)
```

What are the ranges for percentage of white population per county?

```{r}
max(ethnicity_nri$white_percentage, na.rm = TRUE)
min(ethnicity_nri$white_percentage, na.rm = TRUE)
```


```{r}
ggplot(ethnicity_nri) +
  geom_point(aes(x = community_risk_factor_value, 
                 y = white_percentage, 
                 col = national_risk_index_rating_composite)) +
  scale_color_viridis_d() +
  theme_minimal()
```


```{r}
# ethnicity_nri_perc <- ethnicity_nri |> 
#   mutate()

heatmap <- ethnicity_nri |>
  mutate(avg_white_pop = white_pop/total_pop) |> 
   mutate(avg_black_pop = black_pop/total_pop) |> 
   mutate(avg_indigenous_pop = indigenous_pop/total_pop) |> 
   mutate(avg_asian_pop = asian_pop/total_pop) |> 
   mutate(avg_paci_islander_pop = paci_islander_pop/total_pop) |> 
   mutate(avg_other_race = other_race/total_pop) |> 
   mutate(avg_two_races = two_races/total_pop) |> 
   mutate(avg_latino_pop = latino_pop/total_pop) |> 
  select(county_name, 
         avg_white_pop,
         avg_black_pop,
         avg_indigenous_pop,
         avg_asian_pop,
         avg_paci_islander_pop,
         avg_other_race,
         avg_two_races,
         avg_latino_pop) |> 
  pivot_longer(cols = -county_name,
               names_to = "variable",
               values_to = "values") |> 
  drop_na()

ggplot(heatmap, aes(x = county_name, y = variable, fill=values)) +
  geom_tile()


```


Maybe a stacked barplot

```{r}
# ggplot(data, aes(fill=condition, y=value, x=specie)) + 
#     geom_bar(position="fill", stat="identity")

bp_ethnicity_nri <- ethnicity_nri |>  
  select(county_name, 
         white_pop,
         black_pop,
         indigenous_pop,
         asian_pop,
         paci_islander_pop,
         other_race,
         two_races,
         latino_pop) |> 
  pivot_longer(cols = -county_name,
               names_to = "variable",
               values_to = "values") 

bp_ethnicity_nri <- left_join(bp_ethnicity_nri, nri, by = join_by(county_name))

bp_ethnicity_nri <- bp_ethnicity_nri |> 
   select(county_name, 
         variable,
         values,
         national_risk_index_rating_composite) |> 
  drop_na()

```

Define a color palette.
```{r}
asian <- "#560bad"
black <- "#8BC34A"
indigenous <- "#AD1457"
white <- "#F44336"
latino <- "#009688"
other <- "#F9C74F"
two <- "#FF9800"
pacif_islander <- "#1565C0"

```


```{r}
very_high <- bp_ethnicity_nri |> 
  filter(national_risk_index_rating_composite == "Very High") |> 
ggplot(aes(fill= variable , y=values, x=county_name)) + 
    geom_bar(position="fill", stat="identity") +
  coord_flip() +
  
  theme_minimal() + 
  scale_fill_manual(values = c(asian,
                                 black, 
                                 indigenous,
                                 latino, 
                                 other,
                                 pacif_islander,
                                 two, 
                                 white),
                     labels = c("Asian",
                               "Black", 
                               "Indigenous",
                               "Latino", 
                               "Other", 
                               "Pacific Islander",
                               "Two or More Races", 
                               "White")) +
  labs(fill = "Ethnicity Population",
       y = "Percentage",
        title = "Very High NRI Risk") +
  theme(axis.title.y = element_blank())
```
```{r}
relatively_high <- bp_ethnicity_nri |> 
  filter(national_risk_index_rating_composite == "Relatively High") |> 
ggplot(aes(fill= variable , y=values, x=county_name)) + 
    geom_bar(position="fill", stat="identity") +
  coord_flip() +
  theme_minimal() + 
  scale_fill_manual(values = c(asian,
                                 black, 
                                 indigenous,
                                 latino, 
                                 other,
                                 pacif_islander,
                                 two, 
                                 white),
                     labels = c("Asian",
                               "Black", 
                               "Indigenous",
                               "Latino", 
                               "Other", 
                               "Pacific Islander",
                               "Two or More Races", 
                               "White")) +
  labs(fill = "Ethnicity Population",
       y = "Percentage",
        title = "Relatively High NRI Risk") +
  theme(axis.title.y = element_blank())
```

```{r}
relatively_moderate <- bp_ethnicity_nri |> 
  filter(national_risk_index_rating_composite == "Relatively Moderate") |> 
ggplot(aes(fill= variable , y=values, x=county_name)) + 
    geom_bar(position="fill", stat="identity") +
  coord_flip() +
  theme_minimal() + 
  scale_fill_manual(values = c(asian,
                                 black, 
                                 indigenous,
                                 latino, 
                                 other,
                                 pacif_islander,
                                 two, 
                                 white),
                    labels = c("Asian",
                               "Black", 
                               "Indigenous",
                               "Latino", 
                               "Other", 
                               "Pacific Islander",
                               "Two or More Races", 
                               "White")) +
  labs(fill = "Ethnicity Population",
       y = "Percentage",
        title = "Relatively Moderate NRI Risk") +
  theme(axis.title.y = element_blank())
```
```{r}
relatively_low <- bp_ethnicity_nri |> 
  filter(national_risk_index_rating_composite == "Relatively Low") |> 
ggplot(aes(fill= variable , y=values, x=county_name)) + 
    geom_bar(position="fill", stat="identity") +
  coord_flip() +
  theme_minimal() + 
  scale_fill_manual(values = c(asian,
                                 black, 
                                 indigenous,
                                 latino, 
                                 other,
                                 pacif_islander,
                                 two, 
                                 white),
                     labels = c("Asian",
                               "Black", 
                               "Indigenous",
                               "Latino", 
                               "Other", 
                               "Pacific Islander",
                               "Two or More Races", 
                               "White")) +
  labs(fill = "Ethnicity Population",
       y = "Percentage",
        title = "Relatively Low NRI Risk") +
  theme(axis.title.y = element_blank())
```

```{r}


very_high +  relatively_high  + relatively_moderate + relatively_low +
  plot_annotation(title = "NRI and Ethnicity Scores for Counties in California",
                  theme = theme(plot.title = element_text(size = 24, face = "bold"))) + 
  plot_layout(guides = "collect",
              axis_titles = "collect")


```
